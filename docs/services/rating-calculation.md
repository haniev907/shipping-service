# Rating calculation (`services/rating-calculation/`)

Сервис отвечает за подсчет рейтинга пользователя, исходя из его исторических балансов. Логика построения балансов описана [здесь](/docs/services/balances-fetcher.md). Сервис состоит из трех микросервисов:

1. Ticks fetcher (`/services/rating-calculation/ticks-fetcher.js`)
2. Currency converter (`/services/rating-calculation/currency-converter.js`)
3. Rating calculator (`/services/rating-calculation/rating-calculator.js`)

## Ticks fetcher

Сервис берет из базы балансы, базовую валюту и проверяет наличие в базе тиков для всех валют, перечисленных в состоянии баланса. Корректным считается тик, расположенный не раньше, чем за час до времени баланса. В случае, если корректного тика не найдено, используется функционал для запроса исторических данных. Полученные тики сохраняются в базу и, при наличии необходимых тиков для всех валют в состоянии баланса, сервис отправляет запрос на конвертацию баланса в базовою валюту в сервис `currency-converter`.

Список базовых валют описан в `config/constants.js`:

```javascript
config.baseCurrencies = {
  binance: ['BTC', 'USDT'],
  hitbtc: ['BTC', 'USD'],
};
```

### Диаграмма действий

![diag](/docs/images/rating-calculation-ticks-fetcher.svg)

### Запрос исторических данных

На случай, если у нас нет данных о цене актива (например если ордер был совершен пару лет назад), используется функционал, построенный вокруг API CryptoCompare. Документация самого API расположена [здесь](https://min-api.cryptocompare.com/documentation?key=Historical&cat=dataHistohour). На данный момент используется запрос почасовых тиков. Так как в запросе есть возможность указать максимальное число тиков (2000), то при необходимости получить тик на момент времени `X`, имеет смысл запросить тики для некотрого отрезка `(X-diff, X+diff)`, вместо того, чтобы запрашивать тик только для `X`.

API ключ для CC указывается в `config/constants.js`:

```javascript
config.historicalRates = {
  apiKey: 'asca89s7988d....',
};
```

## Currency converter

Сервис берет отдельные балансы, базовую валюту и переводит состояние баланса в эту валюту. В качестве цены, сервис берет ближайшую цену в часовом промежутке перед временем самого баланса. Балансы, которые необходимо привести к стоимости в базовой валюте, добавляются в очередь сервисом `ticks-fetcher`. Это гарантирует нам то, что на момент запуска `currency-converter`, для конвертируемого баланса уже получены все недостающие тики.

### Диаграмма действий

![diag](/docs/images/rating-calculation-currency-converter.svg)

## Rating calculator

Сервис берет из базы последний рейтинг для каждого валидного API ключа и пытается посчитать для этого ключа новый рейтинг. Для этого используется баланс, идущий сразу после того баланса, который бал использован при построении последнего рейтинга. Баланс должен быть приведен в базовую валюту сервисом `currency-converter`.

### Диаграмма действий

  ![diag](/docs/images/rating-calculation-rating-calculator.svg)

## Запуск сервиса

```
npm run rating-calculation
```
