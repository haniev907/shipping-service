# Balances fetcher (`/services/balances-fetcher/`)

Сервис отвечает за сбор балансов для каждого пользователя платформы. Сервис состоит из двух независимых микросервисов:

1. Сборщик пар (`services/balances-fetcher/pairs.js`)
2. Сборщик ордеров (`services/balances-fetcher/balances.js`)

## Сборщик пар

Сервис с определенной периодичностью запрашивает у биржи текущий баланс пользователя по всем монетам и отфильтровывает нулевые балансы. В результате имеем список "активных" монет пользователя (с ненулевым балансов). После чего сервис запрашивает из базы список пар на бирже (подробнее в [stockpairs-fetcher](/docs/services/stockpairs-fetcher.md)) и сохраняет для пользователя те пары, которые включают в себя хотя бы одну "активную" монету.

### Диаграмма действий сервиса

![diag](/docs/images/balances-fetcher-pair.svg)

## Сборщик ордеров

Сервис с определенной периодичностью берет список пар для каждого пользователя (получены с помощью сборщика пар) и запрашивает через API биржи по ним ордера. Если для какой-то пары в базе уже есть ордера, то ордера запрашиваются со сдвигом по времени (от последнего ордера).

При наличие новых ордеров, сервис начинает строить новые балансы. Каждый баланс строится из оредров, сгрупированных в промежутке длиной в 1 час. Данный параметр устанавливается в `config/constants.js`:

```javascript
// Group orders by one hour
config.gapToGroupOrders = 60 * 60 * 1000;
```

Ключевой частью объекта баланса является его состояние (поле `state`). Состояние строится следующим образом (пример):

1. Последний баланс пользователя содержит состояние `{ ETH: 1, BTC: -1 }`
2. Пользователь провел ордер __Продажа 0.5 ETH по цене 1 BTC__.
  1. `ETH amount = 1 - 0.5`
  2. `BTC amount = -1 + 0.5 * 1`
3. Состояние в новом балансе: `{ ETH: 0.5, BTC: -0.5 }`

При пустом состоянии (построение самого первого баланса) или отсутсвии данных для какой-то монеты, значение состояния для этой монеты считается равным 0.

### Диаграмма действий сервиса

![diag](/docs/images/balances-fetcher-balance.svg)

## FAQ

> Почему не сделать просто сборщик вообще всех ордеров, проведенных пользователем?

Потому что не у всех биржи есть такой метод в API (например Binance). Из-за этого приходится использовать метод "Получить ордера по конкретной паре".

> Может ли так случиться, что пользователь торговал на каких-то парах, после чего были полностью проданы некоторые монеты и в результате сервис вообще не узнает про эти пары?

Да, может. В результате мы не досчитаемся какой-то части сделок и рейтинг формально будет не полным. В какой-то степени решением может быть единоразовый "пробег" по всем возможным парам биржи, но пока что это невозможно из-за ограничений API биржи на число запросов.
